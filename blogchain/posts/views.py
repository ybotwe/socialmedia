import json
from web3 import Web3
from django.shortcuts import render, redirect
from .forms import TweetForm, AddressForm
from web3.middleware import geth_poa_middleware

url = 'https://eth-rinkeby.alchemyapi.io/v2/2KJs0Z4dNd3RODPhgi9wpmZVvB9p-ifo'
web3 = Web3(Web3.HTTPProvider(url))
web3.middleware_onion.inject(geth_poa_middleware, layer=0)
address = web3.toChecksumAddress('0x3712676f4EE0931054A927b14fbbA9a5c8e088C4')
public_key = "0xaF89699C8Ec23836004285485497ca60f5f4c0bF"
private_key = "54aba4d8a877df9b3084463c4ac7e9914643f6c705a0848ecede239c8d4761e9"
abi = json.loads('''
{
"_format": "hh-sol-artifact-1",
"contractName": "BlockMedia",
"sourceName": "contracts/BlockMedia.sol",
"abi": [
    {
    "inputs": [],
    "stateMutability": "nonpayable",
    "type": "constructor"
    },
    {
    "anonymous": false,
    "inputs": [
        {
        "indexed": false,
        "internalType": "uint256",
        "name": "postId",
        "type": "uint256"
        },
        {
        "indexed": false,
        "internalType": "string",
        "name": "postContent",
        "type": "string"
        },
        {
        "indexed": false,
        "internalType": "uint256",
        "name": "tipAmount",
        "type": "uint256"
        },
        {
        "indexed": false,
        "internalType": "address",
        "name": "author",
        "type": "address"
        }
    ],
    "name": "PostCreated",
    "type": "event"
    },
    {
    "anonymous": false,
    "inputs": [
        {
        "indexed": false,
        "internalType": "uint256",
        "name": "postId",
        "type": "uint256"
        },
        {
        "indexed": false,
        "internalType": "string",
        "name": "postContent",
        "type": "string"
        },
        {
        "indexed": false,
        "internalType": "uint256",
        "name": "tipAmount",
        "type": "uint256"
        },
        {
        "indexed": false,
        "internalType": "address",
        "name": "author",
        "type": "address"
        }
    ],
    "name": "PostTipped",
    "type": "event"
    },
    {
    "inputs": [
        {
        "internalType": "string",
        "name": "_postContent",
        "type": "string"
        }
    ],
    "name": "createPost",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
    },
    {
    "inputs": [],
    "name": "name",
    "outputs": [
        {
        "internalType": "string",
        "name": "",
        "type": "string"
        }
    ],
    "stateMutability": "view",
    "type": "function"
    },
    {
    "inputs": [
        {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
        }
    ],
    "name": "posts",
    "outputs": [
        {
        "internalType": "uint256",
        "name": "id",
        "type": "uint256"
        },
        {
        "internalType": "string",
        "name": "content",
        "type": "string"
        },
        {
        "internalType": "uint256",
        "name": "tipAmount",
        "type": "uint256"
        },
        {
        "internalType": "address",
        "name": "author",
        "type": "address"
        }
    ],
    "stateMutability": "view",
    "type": "function"
    },
    {
    "inputs": [
        {
        "internalType": "uint256",
        "name": "_id",
        "type": "uint256"
        }
    ],
    "name": "tipPost",
    "outputs": [],
    "stateMutability": "payable",
    "type": "function"
    },
    {
    "inputs": [],
    "name": "totalPosts",
    "outputs": [
        {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
        }
    ],
    "stateMutability": "view",
    "type": "function"
    }
],
"bytecode": "0x608060405260006001553480156200001657600080fd5b506040518060400160405280600a81526020017f426c6f636b4d656469610000000000000000000000000000000000000000000081525060009080519060200190620000649291906200006b565b5062000180565b82805462000079906200011b565b90600052602060002090601f0160209004810192826200009d5760008555620000e9565b82601f10620000b857805160ff1916838001178555620000e9565b82800160010185558215620000e9579182015b82811115620000e8578251825591602001919060010190620000cb565b5b509050620000f89190620000fc565b5090565b5b8082111562000117576000816000905550600101620000fd565b5090565b600060028204905060018216806200013457607f821691505b602082108114156200014b576200014a62000151565b5b50919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b610bfa80620001906000396000f3fe60806040526004361061004a5760003560e01c806306fdde031461004f5780630b1e7f831461007a57806374d3c1f8146100ba5780638e53fb41146100d6578063c7303c6114610101575b600080fd5b34801561005b57600080fd5b5061006461012a565b6040516100719190610836565b60405180910390f35b34801561008657600080fd5b506100a1600480360381019061009c91906107a7565b6101b8565b6040516100b194939291906108bf565b60405180910390f35b6100d460048036038101906100cf91906107a7565b610290565b005b3480156100e257600080fd5b506100eb61050d565b6040516100f89190610858565b60405180910390f35b34801561010d57600080fd5b5061012860048036038101906101239190610766565b610513565b005b6000805461013790610a63565b80601f016020809104026020016040519081016040528092919081815260200182805461016390610a63565b80156101b05780601f10610185576101008083540402835291602001916101b0565b820191906000526020600020905b81548152906001019060200180831161019357829003601f168201915b505050505081565b60026020528060005260406000206000915090508060000154908060010180546101e190610a63565b80601f016020809104026020016040519081016040528092919081815260200182805461020d90610a63565b801561025a5780601f1061022f5761010080835404028352916020019161025a565b820191906000526020600020905b81548152906001019060200180831161023d57829003601f168201915b5050505050908060020154908060030160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905084565b6000811180156102a257506001548111155b6102ab57600080fd5b600060026000838152602001908152602001600020604051806080016040529081600082015481526020016001820180546102e590610a63565b80601f016020809104026020016040519081016040528092919081815260200182805461031190610a63565b801561035e5780601f106103335761010080835404028352916020019161035e565b820191906000526020600020905b81548152906001019060200180831161034157829003601f168201915b50505050508152602001600282015481526020016003820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152505090506000816060015190508073ffffffffffffffffffffffffffffffffffffffff166108fc349081150290604051600060405180830381858888f19350505050158015610418573d6000803e3d6000fd5b50348260400151610429919061097d565b826040018181525050816002600085815260200190815260200160002060008201518160000155602082015181600101908051906020019061046c929190610646565b506040820151816002015560608201518160030160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055509050507f20988fe475351e75813672abada1dddb7ac67cbbeb81e61e1160b8329d8cdf1c600154836020015184604001518460405161050094939291906108bf565b60405180910390a1505050565b60015481565b600081511161052157600080fd5b6001600081548092919061053490610ac6565b919050555060405180608001604052806001548152602001828152602001600081526020013373ffffffffffffffffffffffffffffffffffffffff168152506002600060015481526020019081526020016000206000820151816000015560208201518160010190805190602001906105ae929190610646565b506040820151816002015560608201518160030160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055509050507fc66336337a24e513f909b3b25119854dba8385d51307dbc7d31d1b2805e19c7e6001548260003360405161063b9493929190610873565b60405180910390a150565b82805461065290610a63565b90600052602060002090601f01602090048101928261067457600085556106bb565b82601f1061068d57805160ff19168380011785556106bb565b828001600101855582156106bb579182015b828111156106ba57825182559160200191906001019061069f565b5b5090506106c891906106cc565b5090565b5b808211156106e55760008160009055506001016106cd565b5090565b60006106fc6106f784610930565b61090b565b90508281526020810184848401111561071457600080fd5b61071f848285610a21565b509392505050565b600082601f83011261073857600080fd5b81356107488482602086016106e9565b91505092915050565b60008135905061076081610bad565b92915050565b60006020828403121561077857600080fd5b600082013567ffffffffffffffff81111561079257600080fd5b61079e84828501610727565b91505092915050565b6000602082840312156107b957600080fd5b60006107c784828501610751565b91505092915050565b6107d9816109d3565b82525050565b6107e881610a0f565b82525050565b60006107f982610961565b610803818561096c565b9350610813818560208601610a30565b61081c81610b9c565b840191505092915050565b61083081610a05565b82525050565b6000602082019050818103600083015261085081846107ee565b905092915050565b600060208201905061086d6000830184610827565b92915050565b60006080820190506108886000830187610827565b818103602083015261089a81866107ee565b90506108a960408301856107df565b6108b660608301846107d0565b95945050505050565b60006080820190506108d46000830187610827565b81810360208301526108e681866107ee565b90506108f56040830185610827565b61090260608301846107d0565b95945050505050565b6000610915610926565b90506109218282610a95565b919050565b6000604051905090565b600067ffffffffffffffff82111561094b5761094a610b6d565b5b61095482610b9c565b9050602081019050919050565b600081519050919050565b600082825260208201905092915050565b600061098882610a05565b915061099383610a05565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff038211156109c8576109c7610b0f565b5b828201905092915050565b60006109de826109e5565b9050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b6000610a1a82610a05565b9050919050565b82818337600083830152505050565b60005b83811015610a4e578082015181840152602081019050610a33565b83811115610a5d576000848401525b50505050565b60006002820490506001821680610a7b57607f821691505b60208210811415610a8f57610a8e610b3e565b5b50919050565b610a9e82610b9c565b810181811067ffffffffffffffff82111715610abd57610abc610b6d565b5b80604052505050565b6000610ad182610a05565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff821415610b0457610b03610b0f565b5b600182019050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6000601f19601f8301169050919050565b610bb681610a05565b8114610bc157600080fd5b5056fea2646970667358221220a4d10a9ea010fd72ed1a8bc7d04a286dc430cddaed674d5bf0d618a28a9f76c364736f6c63430008040033",
"deployedBytecode": "0x60806040526004361061004a5760003560e01c806306fdde031461004f5780630b1e7f831461007a57806374d3c1f8146100ba5780638e53fb41146100d6578063c7303c6114610101575b600080fd5b34801561005b57600080fd5b5061006461012a565b6040516100719190610836565b60405180910390f35b34801561008657600080fd5b506100a1600480360381019061009c91906107a7565b6101b8565b6040516100b194939291906108bf565b60405180910390f35b6100d460048036038101906100cf91906107a7565b610290565b005b3480156100e257600080fd5b506100eb61050d565b6040516100f89190610858565b60405180910390f35b34801561010d57600080fd5b5061012860048036038101906101239190610766565b610513565b005b6000805461013790610a63565b80601f016020809104026020016040519081016040528092919081815260200182805461016390610a63565b80156101b05780601f10610185576101008083540402835291602001916101b0565b820191906000526020600020905b81548152906001019060200180831161019357829003601f168201915b505050505081565b60026020528060005260406000206000915090508060000154908060010180546101e190610a63565b80601f016020809104026020016040519081016040528092919081815260200182805461020d90610a63565b801561025a5780601f1061022f5761010080835404028352916020019161025a565b820191906000526020600020905b81548152906001019060200180831161023d57829003601f168201915b5050505050908060020154908060030160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905084565b6000811180156102a257506001548111155b6102ab57600080fd5b600060026000838152602001908152602001600020604051806080016040529081600082015481526020016001820180546102e590610a63565b80601f016020809104026020016040519081016040528092919081815260200182805461031190610a63565b801561035e5780601f106103335761010080835404028352916020019161035e565b820191906000526020600020905b81548152906001019060200180831161034157829003601f168201915b50505050508152602001600282015481526020016003820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152505090506000816060015190508073ffffffffffffffffffffffffffffffffffffffff166108fc349081150290604051600060405180830381858888f19350505050158015610418573d6000803e3d6000fd5b50348260400151610429919061097d565b826040018181525050816002600085815260200190815260200160002060008201518160000155602082015181600101908051906020019061046c929190610646565b506040820151816002015560608201518160030160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055509050507f20988fe475351e75813672abada1dddb7ac67cbbeb81e61e1160b8329d8cdf1c600154836020015184604001518460405161050094939291906108bf565b60405180910390a1505050565b60015481565b600081511161052157600080fd5b6001600081548092919061053490610ac6565b919050555060405180608001604052806001548152602001828152602001600081526020013373ffffffffffffffffffffffffffffffffffffffff168152506002600060015481526020019081526020016000206000820151816000015560208201518160010190805190602001906105ae929190610646565b506040820151816002015560608201518160030160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055509050507fc66336337a24e513f909b3b25119854dba8385d51307dbc7d31d1b2805e19c7e6001548260003360405161063b9493929190610873565b60405180910390a150565b82805461065290610a63565b90600052602060002090601f01602090048101928261067457600085556106bb565b82601f1061068d57805160ff19168380011785556106bb565b828001600101855582156106bb579182015b828111156106ba57825182559160200191906001019061069f565b5b5090506106c891906106cc565b5090565b5b808211156106e55760008160009055506001016106cd565b5090565b60006106fc6106f784610930565b61090b565b90508281526020810184848401111561071457600080fd5b61071f848285610a21565b509392505050565b600082601f83011261073857600080fd5b81356107488482602086016106e9565b91505092915050565b60008135905061076081610bad565b92915050565b60006020828403121561077857600080fd5b600082013567ffffffffffffffff81111561079257600080fd5b61079e84828501610727565b91505092915050565b6000602082840312156107b957600080fd5b60006107c784828501610751565b91505092915050565b6107d9816109d3565b82525050565b6107e881610a0f565b82525050565b60006107f982610961565b610803818561096c565b9350610813818560208601610a30565b61081c81610b9c565b840191505092915050565b61083081610a05565b82525050565b6000602082019050818103600083015261085081846107ee565b905092915050565b600060208201905061086d6000830184610827565b92915050565b60006080820190506108886000830187610827565b818103602083015261089a81866107ee565b90506108a960408301856107df565b6108b660608301846107d0565b95945050505050565b60006080820190506108d46000830187610827565b81810360208301526108e681866107ee565b90506108f56040830185610827565b61090260608301846107d0565b95945050505050565b6000610915610926565b90506109218282610a95565b919050565b6000604051905090565b600067ffffffffffffffff82111561094b5761094a610b6d565b5b61095482610b9c565b9050602081019050919050565b600081519050919050565b600082825260208201905092915050565b600061098882610a05565b915061099383610a05565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff038211156109c8576109c7610b0f565b5b828201905092915050565b60006109de826109e5565b9050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b6000610a1a82610a05565b9050919050565b82818337600083830152505050565b60005b83811015610a4e578082015181840152602081019050610a33565b83811115610a5d576000848401525b50505050565b60006002820490506001821680610a7b57607f821691505b60208210811415610a8f57610a8e610b3e565b5b50919050565b610a9e82610b9c565b810181811067ffffffffffffffff82111715610abd57610abc610b6d565b5b80604052505050565b6000610ad182610a05565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff821415610b0457610b03610b0f565b5b600182019050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6000601f19601f8301169050919050565b610bb681610a05565b8114610bc157600080fd5b5056fea2646970667358221220a4d10a9ea010fd72ed1a8bc7d04a286dc430cddaed674d5bf0d618a28a9f76c364736f6c63430008040033",
"linkReferences": {},
"deployedLinkReferences": {}
}

''')

contract = web3.eth.contract(address=address,abi=abi['abi'])


def get_posts_from_contract():
    contract_func = contract.functions['totalPosts']
    postCount = contract_func().call()

    posts=[]
    for i in range(postCount):
        p = contract.functions.posts(i+1).call()
        posts.append(p)	
    return posts



def posts_list(request):
    posts = get_posts_from_contract()
    posts.sort(key = lambda x: x[2], reverse=True)

    if request.method == 'POST':
        form = AddressForm(request.POST)
        if form.is_valid():
            address = form.cleaned_data.get("address")
            pid = form.cleaned_data.get("post_id")
            new_address = str(address)
            nonce = web3.eth.getTransactionCount(new_address)
            # print(posts[pid-1][3])
            tx = contract.functions.tipPost(pid).buildTransaction({
                # 'to': str(posts[pid - 1][3]),
                'from': web3.toChecksumAddress(new_address),
                'value': 1000000000000000000,
                'chainId':4,
                'gas': 2000000,
                'gasPrice': web3.toWei('40', 'gwei'),
                'nonce': nonce,
            })
            signed_tx = web3.eth.account.signTransaction(tx, private_key)
            tx_hash = web3.eth.sendRawTransaction(signed_tx.rawTransaction)
            tx_receipt = web3.eth.waitForTransactionReceipt(tx_hash)
            form.save()
            return redirect('home')
    else:
        form = AddressForm

    return render(request, 'home.html', {'posts': posts, 'form': form})

def new_post(request):
    if request.method == 'POST':
        form = TweetForm(request.POST)
        if form.is_valid():
            post = form.cleaned_data.get("content")
            new_post = str(post)
            nonce = web3.eth.getTransactionCount(public_key)
            tx = contract.functions.createPost(new_post).buildTransaction({
                'chainId':4,
                'gas': 3000000,
                'gasPrice': web3.toWei('40', 'gwei'),
                'nonce': nonce,
            })
            signed_tx = web3.eth.account.signTransaction(tx, private_key)
            tx_hash = web3.eth.sendRawTransaction(signed_tx.rawTransaction)
            tx_receipt = web3.eth.waitForTransactionReceipt(tx_hash)
            form.save()
            return redirect('home')
    else:
        form = TweetForm

    return render(request, 'new_post.html', {'form': form })
